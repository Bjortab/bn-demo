<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlushNarratives — Core (GC no-autoplay)</title>
  <style>
    :root {
      --bg:#0d0f12; --panel:#151820; --muted:#9aa3b2; --text:#e8eef9; --accent:#e63946;
      --ok:#20c997; --warn:#ffd166; --err:#ff6b6b; --btn:#1f2532; --btnh:#263043; --border:#273043; --ready:#1db954;
    }
    * { box-sizing:border-box }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; display:flex; justify-content:center; padding:24px }
    .wrap { width:min(1100px,100%) }
    header { margin-bottom:16px }
    h1 { font-size:22px; margin:0 0 4px }
    .status { color:var(--muted); font-size:13px }
    .ok { color:var(--ok) }
    .err { color:var(--err); white-space:pre-wrap }
    .warn { color:var(--warn) }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0 }
    label { display:block; font-weight:600; margin:10px 0 6px }
    textarea, select, input[type="number"], input[type="text"] { width:100%; background:#0f1218; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none }
    textarea { min-height:120px; resize:vertical }
    .row { display:flex; gap:12px; flex-wrap:wrap }
    .row .col { flex:1 1 200px }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px }
    button { background:var(--btn); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700 }
    button.primary { background:var(--accent) }
    button:disabled { opacity:.6; cursor:not-allowed }
    .right { margin-left:auto; color:var(--muted); font-size:12px }
    .audioRow { display:flex; align-items:center; gap:12px; margin-top:10px }
    audio { width:100% }
    .ready { background:var(--ready)!important; border-color:#0000!important }
    pre.out { white-space:pre-wrap; margin:0 }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BlushNarratives — Core</h1>
    <div id="status" class="status">Init…</div>
  </header>

  <section class="card">
    <label for="prompt">Din prompt</label>
    <textarea id="prompt" placeholder="Ex: Vi möttes på tåget, hennes blick fastnade på mig…"></textarea>

    <div class="row">
      <div class="col">
        <label for="level">Nivå (1–5)</label>
        <select id="level">
          <option value="1">1 — romantiskt/antydande</option>
          <option value="2" selected>2 — antydande</option>
          <option value="3">3 — sensuellt</option>
          <option value="4">4 — explicit inom gränserna</option>
          <option value="5">5 — direkt & rått (inom lagens ramar)</option>
        </select>
      </div>
      <div class="col">
        <label for="minutes">Längd (minuter)</label>
        <input id="minutes" type="number" min="1" max="15" step="1" value="5" />
      </div>
      <div class="col">
        <label for="lang">Språk</label>
        <select id="lang">
          <option value="sv" selected>Svenska</option>
          <option value="en">Engelska</option>
        </select>
      </div>
      <div class="col">
        <label for="voice">Röst (valfri, t.ex. “anneli”)</label>
        <input id="voice" type="text" placeholder="anneli" />
      </div>
    </div>

    <div class="actions">
      <button id="go" class="primary">Generera</button>
      <button id="prep">Hämta röst</button>
      <button id="play" disabled>Spela upp</button>
      <button id="stop">Stoppa</button>
      <span id="busy" class="status"></span>
      <span class="right">API: <span id="apiUrl"></span></span>
    </div>

    <div class="audioRow">
      <audio id="player" controls preload="none"></audio>
    </div>
  </section>

  <section class="card">
    <label>Berättelse (text)</label>
    <pre id="out" class="out"></pre>
    <div id="err" class="err"></div>
  </section>
</div>

<script>
/** ======= KONFIG ======= **/
const API_BASE = "https://bn-worker.bjorta-bb.workers.dev/api/v1"; // ändra om din worker-URL skiljer sig

/** ======= HJÄLP ======= **/
const $ = sel => document.querySelector(sel);
const statusBox = $("#status");
const out = $("#out");
const errBox = $("#err");
const player = $("#player");
const busy = $("#busy");
const apiUrlSpan = $("#apiUrl");
const btnGo = $("#go");
const btnPrep = $("#prep");
const btnPlay = $("#play");
const btnStop = $("#stop");
apiUrlSpan.textContent = API_BASE;

let lastResult = null; // sparar senaste { text, audio }

/** Audio helpers */
function clearAudio() {
  try { player.pause(); } catch(_){}
  player.removeAttribute("src");
  player.load();
  btnPlay.disabled = true;
  btnPlay.classList.remove("ready");
}
function setAudio(dataUrl) {
  clearAudio();
  if (dataUrl && dataUrl.startsWith("data:audio")) {
    player.src = dataUrl;             // vi AUTOSPELAR INTE
    btnPlay.disabled = false;         // gör knappen aktiv
    btnPlay.classList.add("ready");   // grön när klart
  }
}

/** UI-busy */
function setBusy(on, msg="") {
  btnGo.disabled = !!on;
  btnPrep.disabled = !!on;
  busy.textContent = on ? (msg || "Arbetar…") : "";
}

/** Snygg feltext */
async function responseToError(r) {
  let t = "";
  try { t = await r.text(); } catch {}
  return `HTTP ${r.status} ${r.statusText}\n${t}`;
}

/** ======= INIT ======= **/
async function fetchStatus() {
  try {
    const r = await fetch(`${API_BASE}/status`);
    if (!r.ok) throw new Error(await responseToError(r));
    const j = await r.json();
    const tts = j.tts?.provider || "?";
    statusBox.innerHTML = `OK · worker: <span class="ok">${j.worker}</span> · v ${j.v || "?"} · model: ${j.model || "?"} · tts: ${tts}`;
  } catch (e) {
    statusBox.innerHTML = `<span class="err">Statusfel: ${e.message}</span>`;
  }
}
fetchStatus();

/** ======= HANDLARE ======= **/
btnStop.addEventListener("click", clearAudio);
btnPlay.addEventListener("click", async () => {
  try { await player.play(); } catch(_){}
});

btnGo.addEventListener("click", async () => {
  errBox.textContent = "";
  out.textContent = "";
  clearAudio();
  lastResult = null;

  const prompt = $("#prompt").value.trim();
  const level = Number($("#level").value);
  const minutes = Number($("#minutes").value);
  const lang = $("#lang").value;
  const voice_id = $("#voice").value.trim() || undefined;

  if (!prompt) { errBox.textContent = "Skriv en prompt först."; return; }

  setBusy(true, "Skapar text…");

  try {
    const r = await fetch(`${API_BASE}/episodes/generate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, level, minutes, lang, voice_id })
    });
    if (!r.ok) throw new Error(await responseToError(r));
    const j = await r.json();
    if (!j?.ok) throw new Error(j?.error || "Okänt fel");

    lastResult = j;
    out.textContent = j.text || "";

    if (j.audio) {
      // ljud kommer men vi autoplay:ar inte – låt “Hämta röst” hantera setAudio
      busy.textContent = "Röstdata mottagen (klicka Hämta röst).";
      setTimeout(()=>busy.textContent="",1500);
    } else {
      busy.textContent = "Ingen röst från servern (visar text).";
      setTimeout(()=>busy.textContent="",1500);
    }
  } catch (e) {
    errBox.textContent = e.message || String(e);
  } finally {
    setBusy(false);
  }
});

btnPrep.addEventListener("click", () => {
  if (lastResult?.audio) {
    setAudio(lastResult.audio); // laddar in och gör Play-knappen grön
  } else {
    busy.textContent = "Ingen röst att ladda (gör en generering först).";
    setTimeout(()=>busy.textContent="",1500);
  }
});
</script>
</body>
</html>
