<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BlushNarratives — Core</title>
    <style>
      body { background:#0e0e0e; color:#eee; font:16px/1.5 system-ui, sans-serif; }
      .wrap { max-width:900px; margin:40px auto; padding:0 16px; }
      textarea { width:100%; min-height:120px; background:#141414; color:#eee; border:1px solid #333; border-radius:6px; padding:12px; }
      .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:10px 0; }
      select, button, input { background:#1e1e1e; color:#eee; border:1px solid #333; border-radius:6px; padding:8px 10px; }
      button.primary { background:#b91c1c; border-color:#b91c1c; }
      button.good { background:#16a34a; border-color:#16a34a; }
      .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; background:#111; border:1px solid #222; border-radius:6px; padding:10px; margin-top:12px; color:#9ef99e; }
      .spinner { display:inline-block; width:18px; height:18px; border:2px solid #555; border-top-color:#eee; border-radius:50%; animation:spin 0.9s linear infinite; vertical-align: text-bottom; margin-left:6px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      audio { width:100%; margin:12px 0; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>BlushNarratives — Core</h1>

      <textarea id="prompt" placeholder="Skriv din prompt…"></textarea>

      <div class="row">
        <label>Nivå:
          <select id="lvl">
            <option value="1">1 – snäll</option>
            <option value="3" selected>3 – mellan</option>
            <option value="5">5 – explicit</option>
          </select>
        </label>
        <label>Längd (min):
          <select id="mins">
            <option>3</option><option selected>5</option><option>8</option><option>10</option>
          </select>
        </label>
        <label>Språk:
          <select id="lang">
            <option value="sv" selected>Svenska</option>
            <option value="en">Engelska</option>
          </select>
        </label>
        <button id="go" class="primary">Generera & lyssna</button>
        <button id="stop">Stoppa röst</button>
        <span id="busy" style="display:none" class="spinner"></span>
      </div>

      <audio id="player" controls></audio>

      <div id="story" style="white-space:pre-wrap;"></div>

      <div class="log" id="log"></div>

    </div>
    <script>
      // ======= CONFIG =======
      const API_BASE = 'https://bn-worker.bjorta-bb.workers.dev/api/v1'; // <-- din worker

      const el = {
        prompt: document.getElementById('prompt'),
        lvl: document.getElementById('lvl'),
        mins: document.getElementById('mins'),
        lang: document.getElementById('lang'),
        go: document.getElementById('go'),
        stop: document.getElementById('stop'),
        busy: document.getElementById('busy'),
        player: document.getElementById('player'),
        story: document.getElementById('story'),
        log: document.getElementById('log'),
      };

      log(`Status…`);
      ping();

      el.go.onclick = async () => {
        try {
          setBusy(true);
          el.go.disabled = true;
          el.go.classList.remove('good');
          el.player.src = ''; el.player.pause();
          el.story.textContent = '';

          const payload = {
            lvl: Number(el.lvl.value),
            minutes: Number(el.mins.value),
            lang: el.lang.value,
            prompt: el.prompt.value || ''
          };
          log(`POST /episodes/generate ${JSON.stringify(payload)}`);

          const r = await fetch(`${API_BASE}/episodes/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();

          if (!data?.ok) throw new Error(data?.error?.detail || 'API error');

          el.story.textContent = data.text || '';
          if (data.audio_url && !data.tts_failed) {
            el.player.src = data.audio_url;
            await el.player.load();
            el.go.classList.add('good');      // signal att ljudet är klart
            el.player.play().catch(()=>{});
          } else {
            log(`Ingen audio (tts_failed=${data.tts_failed || false})`);
          }
        } catch (e) {
          alert(`Failed to fetch. Se loggen för detaljer.`);
          log(`FEL: ${String(e)}`);
        } finally {
          setBusy(false);
          el.go.disabled = false;
        }
      };

      el.stop.onclick = () => {
        try { el.player.pause(); el.player.currentTime = 0; } catch {}
      };

      async function ping() {
        try {
          const r = await fetch(`${API_BASE}/status`);
          const j = await r.json();
          log(`Status: ${JSON.stringify(j)}`);
        } catch (e) {
          log(`Status-fel: ${String(e)}`);
        }
      }

      function log(s) {
        const t = new Date().toLocaleTimeString();
        el.log.textContent += `[${t}] ${s}\n`;
        el.log.scrollTop = el.log.scrollHeight;
      }

      function setBusy(b) {
        el.busy.style.display = b ? 'inline-block' : 'none';
      }
    </script>
  </body>
</html>
