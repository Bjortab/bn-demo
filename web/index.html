<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BlushNarratives — Core (GC)</title>
  <style>
    :root{
      --bg:#0f0f12;--panel:#17171b;--muted:#8b8d93;--text:#e9e9ef;--accent:#ff3355;--ok:#2ecc71;--warn:#ffb84d;--err:#ff5c5c;
      --btn:#22232a;--btn-hover:#2a2b33;--btn-active:#333543;--input:#111218;--border:#2b2c33;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      display:flex;justify-content:center;align-items:flex-start;
    }
    .wrap{width:min(980px,100%);padding:28px 18px}
    h1{margin:0 0 12px;font-size:22px}
    .status{font-size:12px;color:var(--muted);margin-bottom:16px}
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px 16px 10px;
      box-shadow:0 6px 18px rgba(0,0,0,.25)
    }
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{
      width:100%;min-height:110px;background:var(--input);color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:12px;resize:vertical;outline:none
    }
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:12px 0}
    .grid .field{background:var(--input);border:1px solid var(--border);border-radius:10px;padding:10px}
    select,input[type="number"]{
      width:100%;background:transparent;border:0;color:var(--text);font-weight:600;outline:none
    }
    .row{display:flex;gap:10px;align-items:center;margin:8px 0 2px}
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);
      padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s;user-select:none
    }
    .btn:hover{background:var(--btn-hover)}
    .btn:active{background:var(--btn-active)}
    .btn.main{background:var(--accent);border-color:transparent;font-weight:700}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.play.ready{background:var(--ok);border-color:#1f9d5a;color:#08140e}
    .log{white-space:pre-wrap;background:#0b0c10;border:1px solid var(--border);border-radius:10px;color:#cfd3dc;
      padding:10px;min-height:36px;max-height:170px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .story{
      margin-top:12px;background:#0d0e13;border:1px solid var(--border);border-radius:12px;padding:12px;min-height:80px
    }
    .story p{margin:.45em 0}
    audio{width:100%;margin-top:8px}
    .api{font-size:11px;color:var(--muted);margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#11121a;font-size:12px;color:var(--muted)}
    .chip.ok{color:#a6f4c5;border-color:#1f9d5a;background:#0c1a13}
    .chip.err{color:#ffd0d0;border-color:#7a1d1d;background:#180d0d}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BlushNarratives — Core</h1>
    <div class="status">
      <span id="statusBadge" class="chip">Init…</span>
      <span id="ttsBadge" class="chip right">TTS ok?</span>
    </div>

    <div class="card">
      <label class="small">Din prompt</label>
      <textarea id="prompt" placeholder="Ex: Vi möttes på tåget, hennes blick fastnade på mig…"></textarea>

      <div class="grid">
        <div class="field">
          <label class="small">Nivå (1–5)</label>
          <select id="level">
            <option value="1">1 – romantik</option>
            <option value="2" selected>2 – antydande</option>
            <option value="3">3 – sensuellt</option>
            <option value="4">4 – explicit</option>
            <option value="5">5 – explicit (hard)</option>
          </select>
        </div>
        <div class="field">
          <label class="small">Längd (minuter)</label>
          <input id="minutes" type="number" min="1" max="20" step="1" value="5"/>
        </div>
        <div class="field">
          <label class="small">Språk</label>
          <select id="lang">
            <option value="sv" selected>Svenska</option>
            <option value="en">Engelska</option>
          </select>
        </div>
        <div class="field">
          <label class="small">Worker</label>
          <input id="apiBase" type="text" value="https://bn-worker.bjorta-bb.workers.dev" />
        </div>
      </div>

      <div class="row">
        <button id="goBtn" class="btn main">Generera & lyssna</button>
        <button id="stopBtn" class="btn">Stoppa röst</button>
        <button id="playBtn" class="btn play" disabled>Spela upp</button>
        <span id="hint" style="color:var(--muted);font-size:12px;margin-left:auto">Knappen blir grön när rösten är klar</span>
      </div>

      <audio id="player" controls preload="none"></audio>

      <div class="story" id="story"></div>
      <div class="api">API: <span id="apiLabel"></span></div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <label class="small">Logg</label>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // ---- Helpers ------------------------------------------------------------
    const $ = (sel)=>document.querySelector(sel);
    const log = (msg, type='info')=>{
      const box = $('#log');
      const t = new Date().toLocaleTimeString();
      box.textContent += `[${t}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    };
    const paragraphs = (text)=>{
      return text
        .replace(/\r\n/g, '\n')
        .split(/\n{2,}/)
        .map(s=>s.trim())
        .filter(Boolean)
        .map(p=>`<p>${p}</p>`).join('');
    };
    const setBadge = (el, ok, labelOk, labelFail)=>{
      el.classList.remove('ok','err');
      el.textContent = ok ? labelOk : labelFail;
      el.classList.add(ok ? 'ok' : 'err');
    };

    // ---- UI refs ------------------------------------------------------------
    const promptEl  = $('#prompt');
    const levelEl   = $('#level');
    const minutesEl = $('#minutes');
    const langEl    = $('#lang');
    const apiBaseEl = $('#apiBase');

    const goBtn   = $('#goBtn');
    const stopBtn = $('#stopBtn');
    const playBtn = $('#playBtn');

    const player  = $('#player');
    const storyEl = $('#story');

    const statusBadge = $('#statusBadge');
    const ttsBadge    = $('#ttsBadge');
    const apiLabel    = $('#apiLabel');

    let audioReady = false;
    let lastAudioUrl = null;

    // ---- Status probe -------------------------------------------------------
    async function probe(){
      const API_BASE = apiBaseEl.value.trim().replace(/\/+$/,'');
      apiLabel.textContent = `${API_BASE}/api/v1`;
      try{
        const r = await fetch(`${API_BASE}/api/v1/status`, { method:'GET' });
        const j = await r.json();
        const ok = j && j.ok === true;
        setBadge(statusBadge, ok, `OK: worker ${j?.v ?? ''}`, 'Worker: offline');
        const ttsOk = j?.tts && (j.tts.provider || j.tts.speechify);
        setBadge(ttsBadge, !!ttsOk, `TTS: ${j?.tts?.provider ?? 'ok'}`, 'TTS: av');
        log(`Status: ${JSON.stringify(j)}`);
        return ok;
      }catch(err){
        setBadge(statusBadge, false, '', 'Worker: offline');
        setBadge(ttsBadge, false, '', 'TTS: av');
        log(`Status fel: ${String(err)}`, 'err');
        return false;
      }
    }

    // ---- Generate flow ------------------------------------------------------
    async function generate(){
      const API_BASE = apiBaseEl.value.trim().replace(/\/+$/,'');
      const prompt  = promptEl.value.trim();
      const level   = Number(levelEl.value);
      const minutes = Number(minutesEl.value);
      const lang    = langEl.value;

      audioReady = false;
      playBtn.disabled = true;
      playBtn.classList.remove('ready');

      if(!prompt){ alert('Skriv en prompt först.'); promptEl.focus(); return; }

      goBtn.disabled = true;
      goBtn.textContent = 'Genererar…';
      storyEl.innerHTML = '';
      player.pause();
      if(lastAudioUrl){ URL.revokeObjectURL(lastAudioUrl); lastAudioUrl = null; }
      player.removeAttribute('src');
      player.load();

      log(`POST /episodes/generate (${minutes} min, nivå ${level}, ${lang})`);

      try{
        const res = await fetch(`${API_BASE}/api/v1/episodes/generate`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt, level, minutes, lang })
        });

        const data = await res.json().catch(()=> ({}));
        if(!res.ok || !data.ok){
          throw new Error(data?.error || `HTTP ${res.status}`);
        }

        // Text
        const text = data.text || '';
        storyEl.innerHTML = paragraphs(text || '(ingen text)');
        log(`Berättelsetext: ${text.slice(0,140)}${text.length>140?'…':''}`);

        // Ljud
        if(data.audio){
          const b64 = data.audio.replace(/^data:audio\/\w+;base64,/,'');
          const byteChars = atob(b64);
          const byteNums = new Uint8Array(byteChars.length);
          for(let i=0;i<byteChars.length;i++) byteNums[i] = byteChars.charCodeAt(i);
          const blob = new Blob([byteNums], { type:'audio/mpeg' });
          lastAudioUrl = URL.createObjectURL(blob);
          player.src = lastAudioUrl;
          player.load();

          audioReady = true;
          playBtn.disabled = false;
          playBtn.classList.add('ready');
          log(`Ljud klart (${(blob.size/1024).toFixed(1)} KB). Klicka "Spela upp".`);
        }else{
          log('Ingen audio returnerades (TTS av eller fel).', 'warn');
        }

      }catch(err){
        log(`Fel vid generering: ${String(err.message || err)}`, 'err');
        alert(`Fel: ${String(err.message || err)}`);
      }finally{
        goBtn.disabled = false;
        goBtn.textContent = 'Generera & lyssna';
      }
    }

    // ---- Events -------------------------------------------------------------
    goBtn.addEventListener('click', generate);
    stopBtn.addEventListener('click', ()=>{
      player.pause();
      player.currentTime = 0;
    });
    playBtn.addEventListener('click', ()=>{
      if(!audioReady){ return; }
      player.play().catch(e=>{
        log(`Kunde inte spela upp: ${String(e)}`, 'err');
      });
    });
    apiBaseEl.addEventListener('change', probe);

    // ---- Init ---------------------------------------------------------------
    (async()=>{
      // Förifyll ett mjukt exempel
      promptEl.value = 'Vi möttes på tåget, hennes blick fastnade på mig när vagnen rullade ut från perrongen.';
      await probe();
    })();
  </script>
</body>
</html>
