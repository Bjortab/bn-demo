<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>BlushNarratives — Core</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; padding:20px; }
    textarea { width:100%; height:80px; }
    select,button { margin:5px; }
    #story { white-space:pre-wrap; margin-top:20px; background:#222; padding:10px; }
    #log { width:100%; height:150px; background:#000; color:#0f0; font-family:monospace; }
    #spinner{
      width:14px; height:14px;
      border:2px solid #888; border-top-color:transparent;
      border-radius:50%; display:none;
      animation: spin 0.8s linear infinite; margin-left:8px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <h1>BlushNarratives — Core</h1>

  <textarea id="prompt" placeholder="Skriv din prompt här..."></textarea><br/>
  <label>Nivå:
    <select id="level">
      <option value="2">2 – antydande</option>
      <option value="3" selected>3 – mellan</option>
      <option value="5">5 – explicit</option>
    </select>
  </label>
  <label>Längd:
    <select id="minutes">
      <option value="3">3</option>
      <option value="5" selected>5</option>
      <option value="10">10</option>
    </select>
  </label>
  <label>Språk:
    <select id="lang">
      <option value="sv" selected>Svenska</option>
      <option value="en">Engelska</option>
    </select>
  </label><br/>

  <button id="btn-generate">Generera & lyssna</button>
  <button id="btn-stop">Stoppa röst</button>
  <div id="spinner"></div>

  <div id="story"></div>
  <audio id="audio" controls></audio>

  <h3>Logg</h3>
  <textarea id="log" readonly></textarea>

  <script>
  (() => {
    const API_BASE = "https://bn-worker.bjorta-bb.workers.dev/api/v1";

    const btn = document.querySelector("#btn-generate");
    const stopBtn = document.querySelector("#btn-stop");
    const textarea = document.querySelector("#prompt");
    const levelSel = document.querySelector("#level");
    const minutesSel = document.querySelector("#minutes");
    const langSel = document.querySelector("#lang");
    const logBox = document.querySelector("#log");
    const audio = document.querySelector("#audio");
    const spinner = document.querySelector("#spinner");

    function log(line) {
      const t = new Date().toLocaleTimeString();
      logBox.value += `[${t}] ${line}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function showSpinner(on) {
      spinner.style.display = on ? "inline-block" : "none";
    }

    async function safeFetch(url, opts) {
      const options = {
        method: "GET",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        ...opts
      };
      return await fetch(url, options);
    }

    async function checkStatus() {
      try {
        const r = await safeFetch(`${API_BASE}/status`);
        const j = await r.json();
        log(`Status: ${JSON.stringify(j)}`);
      } catch (e) {
        log(`Status FEL: ${e.message}`);
      }
    }

    async function generate() {
      const prompt = (textarea.value || "").trim();
      const level = Number(levelSel.value || 3);
      const minutes = Number(minutesSel.value || 5);
      const lang = (langSel.value || "sv").toLowerCase();

      if (!prompt) {
        alert("Skriv en prompt först.");
        return;
      }

      showSpinner(true);
      btn.disabled = true;
      audio.pause();
      audio.src = "";

      try {
        const body = { prompt, level, minutes, lang };
        log(`POST /episodes/generate (${minutes} min, nivå ${level}, ${lang})`);

        const r = await safeFetch(`${API_BASE}/episodes/generate`, {
          method: "POST",
          body: JSON.stringify(body)
        });

        if (!r.ok) {
          const text = await r.text();
          throw new Error(`HTTP ${r.status} – ${text}`);
        }

        const data = await r.json();
        if (!data.ok) throw new Error(data.error || "Ok=false");

        document.querySelector("#story").textContent = data.text || "";

        if (data.audio) {
          audio.src = data.audio;
          await audio.play().catch(()=>{});
          log("Ljud klart ✅");
        } else {
          log("Ingen audio returnerades (TTS av eller fel).");
        }
      } catch (e) {
        alert(`Fel: ${e.message}`);
        log(`FEL: ${e.message}`);
      } finally {
        showSpinner(false);
        btn.disabled = false;
      }
    }

    btn?.addEventListener("click", generate);
    stopBtn?.addEventListener("click", () => audio.pause());

    checkStatus();
  })();
  </script>
</body>
</html>
